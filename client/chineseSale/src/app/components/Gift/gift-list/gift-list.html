<div class="page-header">
  <h2 class="page-title">×‘×•××• ×œ×‘×—×•×¨ ××ª ×”×¤×¨×¡×™× ×©×œ×›×</h2>
  <p class="page-subtitle">×‘×—×¨×• ××ª× ×•×ª ×•×¨×›×©×• ×›×¨×˜×™×¡×™× ×œ×”×’×¨×œ×”</p>
</div>

<!-- ===== MANAGER SEARCH ===== -->
@if (authService.isManager()) {
<div class="search-panel manager-search">
  <h4>ğŸ” ×—×™×¤×•×© ××ª×§×“× (×× ×”×œ)</h4>
  <div class="search-fields">
    <input type="text" [(ngModel)]="mgrFilterName" placeholder="×©× ××ª× ×”..." class="search-input" />
    <input type="text" [(ngModel)]="mgrFilterDonor" placeholder="×©× ×ª×•×¨×..." class="search-input" />
    <input type="number" [(ngModel)]="mgrFilterBuyers" placeholder="××™× ×™××•× ×§×•× ×™×..." class="search-input" />
    <button class="btn-search" (click)="managerSearch()">×—×¤×©</button>
    <button class="btn-clear" (click)="clearManagerSearch()">× ×§×”</button>
  </div>
</div>
}

<!-- ===== USER SEARCH: Category Pills ===== -->
@if (!authService.isManager()) {
<div class="category-bar">
  <a routerLink="/gifts" class="cat-pill" [class.active]="filterCategory === ''" (click)="filterByCategory('')">
    ğŸ ×›×œ ×”×¤×¨×¡×™×
  </a>
  @for (cat of categories; track cat.id) {
    <button class="cat-pill" [class.active]="filterCategory === cat.name" (click)="filterByCategory(cat.name)">
      {{ cat.name }}
    </button>
  }
</div>
}

<!-- ===== MANAGER ADD BUTTON ===== -->
@if (authService.isManager()) {
  <button class="btn-add" (click)="addGift()">â• ×”×•×¡×¤×ª ××ª× ×” ×—×“×©×”</button>
}

<!-- ===== MANAGER VIEW: Card Rows ===== -->
@if (authService.isManager()) {
<div class="mgr-cards-container">
  <!-- "All gifts" navigation pill -->
  <div class="category-bar mgr-category-bar">
    <a routerLink="/gifts" class="cat-pill active">ğŸ ×›×œ ×”×¤×¨×¡×™×</a>
  </div>

  @for(g of (filteredGifts ?? (gifts$ | async)); track g.id) {
    <div class="mgr-card-row" [class.won]="g.winnerName != 'N/A'">
      <!-- Image section with winner overlay -->
      <a [routerLink]="['/gifts', g.id]" class="mgr-card-image-wrapper">
        @if (g.picture) {
          <img [src]="'images/' + g.picture" [alt]="g.name" class="mgr-card-image" />
        } @else {
          <div class="mgr-card-no-image">ğŸ</div>
        }
        <!-- Winner overlay (similar to user view) -->
        @if (g.winnerName != 'N/A') {
          <div class="winner-overlay">
            <div class="winner-overlay-content">
              <span class="winner-icon">ğŸ†</span>
              <span class="winner-label">×–×•×›×”</span>
              <span class="winner-name">{{ g.winnerName }}</span>
              @if (g.winnerEmail) {
                <span class="winner-email">{{ g.winnerEmail }}</span>
              }
            </div>
          </div>
        }
      </a>

      <!-- Card body: gift info -->
      <div class="mgr-card-body">
        <a [routerLink]="['/gifts', g.id]" class="card-title-link">
          <h3 class="card-title">{{ g.name }}</h3>
        </a>
        <div class="mgr-card-info">
          <span class="mgr-info-item">ğŸ“ {{ g.description }}</span>
          <span class="mgr-info-item">ğŸ’° {{ g.price }} â‚ª</span>
          <span class="mgr-info-item">ğŸ¤ {{ g.donorName }}</span>
          <span class="mgr-info-item">ğŸ“‚ {{ g.categoryName }}</span>
        </div>
      </div>

      <!-- Winner announcement banner (shows immediately after draw) -->
      @if (drawnWinners[g.id]) {
        <div class="winner-banner">
          <h4>ğŸ‰ ×”×–×•×›×” ×‘×”×’×¨×œ×” ğŸ‰</h4>
          <p><strong>×©×:</strong> {{ drawnWinners[g.id].name }}</p>
          <p><strong>××™××™×™×œ:</strong> {{ drawnWinners[g.id].email }}</p>
          <p class="email-notice">ğŸ“§ ××™×™×œ × ×©×œ×— ×œ×–×•×›×”</p>
        </div>
      }

      <!-- Actions -->
      <div class="mgr-card-actions">
        @if (g.winnerName == 'N/A' && !drawnWinners[g.id]) {
          <button class="btn-edit" (click)="openEdit(g.id)">âœï¸ ×¢×¨×™×›×”</button>
          <button class="btn-draw" (click)="drawWinner(g.id, $event)">ğŸ° ×”×’×¨×œ×”</button>
          <button class="btn-add-cart" (click)="addToCart(g); $event.stopPropagation()">ğŸ›’ ×”×•×¡×£ ×œ×¡×œ</button>
        }
        @if (cartMessages[g.id]) {
          <span class="cart-msg">{{ cartMessages[g.id] }}</span>
        }
      </div>
    </div>
  }
</div>
}

<!-- ===== USER VIEW: Cards (Ezer Mitzion style) ===== -->
@if (!authService.isManager()) {
<div class="gifts-grid">
  @for(g of (filteredGifts ?? (gifts$ | async)); track g.id) {
    <div class="gift-card" [class.won]="g.winnerName != 'N/A'">
      <!-- Card Image (clickable -> product page) -->
      <a [routerLink]="['/gifts', g.id]" class="card-image-wrapper">
        @if (g.picture) {
          <img [src]="'images/' + g.picture" [alt]="g.name" class="card-image" />
        } @else {
          <div class="card-no-image">ğŸ</div>
        }
        <!-- Winner overlay -->
        @if (g.winnerName != 'N/A') {
          <div class="winner-overlay">
            <div class="winner-overlay-content">
              <span class="winner-icon">ğŸ†</span>
              <span class="winner-label">×–×•×›×”</span>
              <span class="winner-name">{{ g.winnerName }}</span>
            </div>
          </div>
        }
      </a>

      <!-- Gift Title (clickable -> product page) -->
      <div class="card-body">
        <a [routerLink]="['/gifts', g.id]" class="card-title-link">
          <h3 class="card-title">{{ g.name }}</h3>
        </a>
      </div>

      <!-- Quantity Controls: + [number] âˆ’ (different background) -->
      <div class="card-controls">
        @if (g.winnerName == 'N/A') {
          @if (authService.isLoggedIn()) {
            <div class="qty-row">
              <button class="qty-btn qty-plus" (click)="incrementQty(g)" [disabled]="loading[g.id]">+</button>
              <input
                type="number"
                class="qty-input"
                [value]="getQuantity(g.id)"
                (change)="onQtyChange(g, $event)"
                min="0"
                max="100"
              />
              <button class="qty-btn qty-minus" (click)="decrementQty(g)" [disabled]="loading[g.id] || getQuantity(g.id) <= 0">âˆ’</button>
            </div>
          } @else {
            <button class="btn-login-to-buy" (click)="goToLogin()">ğŸ”‘ ×”×ª×—×‘×¨ ×›×“×™ ×œ×§× ×•×ª</button>
          }
        }
        @if (cartMessages[g.id]) {
          <div class="cart-msg">{{ cartMessages[g.id] }}</div>
        }
      </div>
    </div>
  }
</div>
}

<!-- ===== MANAGER EDIT FORM (MODAL) ===== -->
@if (authService.isManager() && showForm) {
<div class="modal-overlay" (click)="closeForm()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <app-gift-edit [id]="selectedId" (idChange)="onIdChange($event)"></app-gift-edit>
  </div>
</div>
}